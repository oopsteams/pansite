<html lang="en" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video</title>
    <link href="https://static.oopsteam.site/static/css/base.css" rel="stylesheet" type="text/css"/>
    <script src="https://static.oopsteam.site/static/js/jquery-ui/external/jquery/jquery.js" type="text/javascript"></script>
    <script src="https://static.oopsteam.site/static/js/psclient.js" type="text/javascript"></script>
</head>
<body>
<div id="info">

</div>
<textarea id="txt"></textarea>
<button id="send" value="发送">发送</button>
<script type="text/javascript">

</script>
<script type="text/javascript">
var msg_list = [];

pushclient.pclient.response.onmessage=function(kind,msg,params){


    if(kind==Kind.STRING){

        var idx = msg.indexOf(":");
        var tag = "";
        if (idx > 0) tag = msg.substring(0, idx);
        var _idx = idx;
        idx = msg.indexOf(":", _idx + 1);
        var sn = "";
        if (idx > _idx) {
            sn = msg.substring(_idx + 1, idx);
            if (sn) {
                pushclient.pclient.request.recvOk(sn);
            }
        }

        console.log('msg:'+msg);
        var vals = msg.split(":");
        var tag = vals[0];
        if("apply"==tag){
            var from = params[0];
            window.fromuid=from;
            var page = ~~vals[1];
            var sn = vals[2];
            pushclient.pclient.request.apply(page,sn);
        }else if("msg"==tag){
             var from = params[0];
             window.fromuid=from;
             var sn = vals[1];
             var txt = vals[2];
             console.log("来自"+from+"["+sn+"]:"+txt);
             pushclient.pclient.cb('recv', from, sn, txt);
         }
    }else if(kind==Kind.BYTE){}
};
window.fromuid=1001;
pushclient.pclient.request.host='wss.oopsteam.site';
pushclient.pclient.request.port=19443;
pushclient.pclient.request.token='XL001';
pushclient.pclient.request.uuid=1000;
pushclient.pclient.request.fixport=19443;
//pushclient.pclient.request.uuid=2001;
pushclient.pclient.request.proxy="wss";
pushclient.pclient.request.add('sids','1');
pushclient.pclient.request.add('vids','51888');
pushclient.pclient.request.add('cat','1');
pushclient.pclient.request.add('tid','51888.1');//组id store+idx
pushclient.pclient.start();

var target_uid = 142;
var target_name = "匿名";
$(function () {
   $('#send').click(function () {
       var txt = $('#txt').val();
       var sn = sendText(txt, target_uid);
       var msg_item = {name: "我", msg: txt, 'time': parseInt(sn), 'at': 'right'}
        msg_list.push(msg_item);
       update_view();
   });
});

var disabled = true;
function update_view(){
    $('#info').html('');
    msg_list.forEach(function (item) {
        $('#info').append($('<div style="text-align:'+item.at+';font-size: 8px;width: 100%;">'+item.name+':'+item.msg+':'+item.time+'</div>'))
    });
}
function initUserBody(cb){
    var tk = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MSwiZSI6IjIwMjAtMDktMDYgMjI6MTQ6MDMrMDg6MDAiLCJvaWQiOiIiLCJhIjoxLCJjaWQiOiIxNDIiLCJtbyI6IiIsInRtIjoxNTk5Mzg3MjQzfQ.RY5cj3vBo5osZ3vCZBFU06kWwcuC4yG5VQirp6m7rb8';
    $.ajax({url:"https://test.orcaengine.com/api/im/guest_list?team_id=51888.1",
        type:'GET',
        headers:{
        "content-type": "application/json",
              "XL-TOKEN": tk
        },
        success: function (res) {
            console.log("initMsgBody res:", res);
            if(res.data){
                // msg_list = res.data;
            }
            if(cb){
                cb();
            }
        }
    });
}
function initMsgBody(cb){
    var tk = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6MSwiZSI6IjIwMjAtMDktMDYgMjI6MTQ6MDMrMDg6MDAiLCJvaWQiOiIiLCJhIjoxLCJjaWQiOiIxNDIiLCJtbyI6IiIsInRtIjoxNTk5Mzg3MjQzfQ.RY5cj3vBo5osZ3vCZBFU06kWwcuC4yG5VQirp6m7rb8';
    $.ajax({url:"https://test.orcaengine.com/api/im/store_msg_list?team_id=51888.1&chat_id="+target_uid,
        type:'GET',
        headers:{
        "content-type": "application/json",
              "XL-TOKEN": tk
        },
        success: function (res) {
            if(res.data){
                console.log("data:", res.data);
                msg_list = res.data.messages;
                target_name = res.data.client;
            }
            if(cb){
                cb();
            }
        }
    });
}
pushclient.pclient.cb=function (tag, _from, sn, txt) {
    console.log("chatmsg:", txt);
      if('recv'==tag){//接收到消息
        // self.setData({"chatmsg": txt, "chatfrom":_from});
        var msg = {name: _from, msg: txt, 'time': parseInt(sn), 'at': 'left'}
        var sec = _from.split("_");
        var _target_uid = sec[2];
        if(_target_uid != target_uid){
            target_uid = _target_uid;
            initMsgBody(()=>{
                update_view();
            });
        }
        console.log("target_uid:", target_uid);
        msg_list.push(msg);
        update_view();
      }else if('ready'==tag){//消息通道ok
        console.log("消息通道ok");
        //加载历史消息

        initUserBody(()=>{
            disabled = false;
            initMsgBody(()=>{
                update_view();
            });

        });
      }else if('disc'==tag){//因为网络问题连接断开
      console.log("消息通道断开");
        disabled = true;
        update_view();
      }
    
}
//pushclient.pclient.request.sendbytes("2001","","jpg",new Blob())


function sendText(txt,touid){
    var sid=pushclient.pclient.request.defaultSid;
    var vid=pushclient.pclient.request.defaultGid;
    var routeid=3;
    if(!touid)touid=window.fromuid;
    var sn = ""+(new Date()).getTime();
    console.log("sendText sid:", sid, ",vid:", vid);
    pushclient.pclient.request.nsend(10, sid, vid, routeid, touid,"dhbyuid","msg:"+sn+":"+txt);
    return sn;
}
function sendTag(tag, gid, cb) {
    var sid = pushclient.pclient.request.defaultSid;
    var vid = gid;
    var routeid = 2;
    var md = "downhit";
    var sn = "" + (new Date()).getTime();
    setCallBack(pushclient, cb);
    pushclient.pclient.request.nsend(0, sid, vid, routeid, vid, md, tag+":" + sn + ":");
    return sn;
}
</script>
</body>
</html>